<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - Myntra</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .is-invalid {
        border-color: #dc3545 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }
      .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
      }
      .was-validated .form-control:invalid ~ .invalid-feedback,
      .form-control.is-invalid ~ .invalid-feedback {
        display: block;
      }
      .form-control:focus {
        border-color: #fd5c63;
        box-shadow: 0 0 0 0.25rem rgba(253, 92, 99, 0.25);
      }
    </style>
  </head>
  <body>
    <div id="site-header"></div>

    <div class="container my-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow">
            <div class="card-body p-4">
              <h2 class="mb-4">My Profile</h2>
              <div id="profile-success" class="alert alert-success d-none">
                Profile updated successfully!
              </div>
              <div id="profile-error" class="alert alert-danger d-none"></div>

              <form id="profile-form" class="needs-validation" novalidate>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">Full Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="name"
                      pattern="^[a-zA-Z\s]{2,50}$"
                      required
                    />
                    <div class="invalid-feedback">
                      Please enter a valid name (2-50 characters, letters only).
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="phone"
                      pattern="[0-9]{10}"
                      required
                    />
                    <div class="invalid-feedback">
                      Please enter a valid 10-digit phone number.
                    </div>
                  </div>
                </div>

                <h5 class="mt-4 mb-3">Address</h5>
                <div class="mb-3">
                  <label for="address-line1" class="form-label"
                    >Address Line 1</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="address-line1"
                    minlength="5"
                    maxlength="100"
                    required
                  />
                  <div class="invalid-feedback">
                    Please enter a valid address (5-100 characters).
                  </div>
                </div>
                <div class="mb-3">
                  <label for="address-line2" class="form-label"
                    >Address Line 2 (Optional)</label
                  >
                  <input type="text" class="form-control" id="address-line2" />
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="city" class="form-label">City</label>
                    <input
                      type="text"
                      class="form-control"
                      id="city"
                      pattern="^[a-zA-Z\s]{2,50}$"
                      required
                    />
                    <div class="invalid-feedback">
                      Please enter a valid city name (letters only).
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="state" class="form-label">State</label>
                    <select class="form-select" id="state" required>
                      <option value="" disabled selected>Select State</option>
                      <option value="Andhra Pradesh">Andhra Pradesh</option>
                      <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                      <option value="Assam">Assam</option>
                      <option value="Bihar">Bihar</option>
                      <option value="Chhattisgarh">Chhattisgarh</option>
                      <option value="Goa">Goa</option>
                      <option value="Gujarat">Gujarat</option>
                      <option value="Haryana">Haryana</option>
                      <option value="Himachal Pradesh">Himachal Pradesh</option>
                      <option value="Jharkhand">Jharkhand</option>
                      <option value="Karnataka">Karnataka</option>
                      <option value="Kerala">Kerala</option>
                      <option value="Madhya Pradesh">Madhya Pradesh</option>
                      <option value="Maharashtra">Maharashtra</option>
                      <option value="Manipur">Manipur</option>
                      <option value="Meghalaya">Meghalaya</option>
                      <option value="Mizoram">Mizoram</option>
                      <option value="Nagaland">Nagaland</option>
                      <option value="Odisha">Odisha</option>
                      <option value="Punjab">Punjab</option>
                      <option value="Rajasthan">Rajasthan</option>
                      <option value="Sikkim">Sikkim</option>
                      <option value="Tamil Nadu">Tamil Nadu</option>
                      <option value="Telangana">Telangana</option>
                      <option value="Tripura">Tripura</option>
                      <option value="Uttar Pradesh">Uttar Pradesh</option>
                      <option value="Uttarakhand">Uttarakhand</option>
                      <option value="West Bengal">West Bengal</option>
                      <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                      <option value="Chandigarh">Chandigarh</option>
                      <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                      <option value="Delhi">Delhi</option>
                      <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                      <option value="Ladakh">Ladakh</option>
                      <option value="Lakshadweep">Lakshadweep</option>
                      <option value="Puducherry">Puducherry</option>
                    </select>
                    <div class="invalid-feedback">
                      Please select your state.
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="pincode" class="form-label">Pincode</label>
                    <input
                      type="text"
                      class="form-control"
                      id="pincode"
                      pattern="^[1-9][0-9]{5}$"
                      required
                    />
                    <div class="invalid-feedback">
                      Please enter a valid 6-digit pincode.
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <a href="index.html" class="btn btn-outline-secondary"
                    >Back to Home</a
                  >
                  <button type="submit" class="btn btn-danger">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="auth.js"></script>
    <script>
      // Form validation functions
      function validateName() {
        const nameInput = document.getElementById("name");
        const name = nameInput.value.trim();
        const isValid = /^[a-zA-Z\s]{2,50}$/.test(name);

        nameInput.classList.toggle("is-invalid", !isValid && name);
        return isValid;
      }

      function validatePhone() {
        const phoneInput = document.getElementById("phone");
        const phone = phoneInput.value.trim();
        const isValid = /^[0-9]{10}$/.test(phone);

        phoneInput.classList.toggle("is-invalid", !isValid && phone);
        return isValid;
      }

      function validateAddressLine1() {
        const input = document.getElementById("address-line1");
        const value = input.value.trim();
        const isValid = value.length >= 5 && value.length <= 100;

        input.classList.toggle("is-invalid", !isValid && value);
        return isValid;
      }

      function validateCity() {
        const input = document.getElementById("city");
        const value = input.value.trim();
        const isValid = /^[a-zA-Z\s]{2,50}$/.test(value);

        input.classList.toggle("is-invalid", !isValid && value);
        return isValid;
      }

      function validateState() {
        const input = document.getElementById("state");
        const isValid = input.value !== "";

        input.classList.toggle("is-invalid", !isValid);
        return isValid;
      }

function validatePincode() {
    const input = document.getElementById('pincode');
    const stateSelect = document.getElementById('state');
    const value = input.value.trim();
    let isValid = /^[1-9][0-9]{5}$/.test(value);
    
    // State-wise pincode validation
    if (isValid && stateSelect.value) {
        const pincode = parseInt(value);
        const state = stateSelect.value;
        
        // Define pincode ranges for states (first 2-3 digits)
        const statePincodes = {
            'Andhra Pradesh': { start: 50, end: 53 },
            'Arunachal Pradesh': { start: 79, end: 79 },
            'Assam': { start: 78, end: 78, start2: 79, end2: 79 },
            'Bihar': { start: 80, end: 85 },
            'Chhattisgarh': { start: 49, end: 49 },
            'Goa': { start: 40, end: 40, start2: 40, end2: 40 },
            'Gujarat': { start: 36, end: 39 },
            'Haryana': { start: 12, end: 13 },
            'Himachal Pradesh': { start: 17, end: 17 },
            'Jharkhand': { start: 81, end: 83 },
            'Karnataka': { start: 56, end: 59 },
            'Kerala': { start: 67, end: 69 },
            'Madhya Pradesh': { start: 45, end: 48 },
            'Maharashtra': { start: 40, end: 44 },
            'Manipur': { start: 79, end: 79 },
            'Meghalaya': { start: 79, end: 79 },
            'Mizoram': { start: 79, end: 79 },
            'Nagaland': { start: 79, end: 79 },
            'Odisha': { start: 75, end: 77 },
            'Punjab': { start: 14, end: 16 },
            'Rajasthan': { start: 30, end: 34 },
            'Sikkim': { start: 73, end: 73 },
            'Tamil Nadu': { start: 60, end: 64 },
            'Telangana': { start: 50, end: 50, start2: 50, end2: 53 },
            'Tripura': { start: 79, end: 79 },
            'Uttar Pradesh': { start: 20, end: 28 },
            'Uttarakhand': { start: 24, end: 24, start2: 24, end2: 24 },
            'West Bengal': { start: 70, end: 74 },
            'Andaman and Nicobar Islands': { start: 74, end: 74 },
            'Chandigarh': { start: 16, end: 16 },
            'Dadra and Nagar Haveli and Daman and Diu': { start: 39, end: 39, start2: 39, end2: 39 },
            'Delhi': { start: 11, end: 11 },
            'Jammu and Kashmir': { start: 18, end: 18, start2: 19, end2: 19 },
            'Ladakh': { start: 19, end: 19 },
            'Lakshadweep': { start: 68, end: 68 },
            'Puducherry': { start: 60, end: 60, start2: 60, end2: 60 }
        };

        const statePincode = statePincodes[state];
        if (statePincode) {
            const prefix = parseInt(value.substring(0, 2));
            isValid = (prefix >= statePincode.start && prefix <= statePincode.end) || 
                     (statePincode.start2 && prefix >= statePincode.start2 && prefix <= statePincode.end2);
            
            if (!isValid) {
                input.setCustomValidity(`Pincode does not match the selected state (${state}).`);
            } else {
                input.setCustomValidity('');
            }
        }
    }
    
    input.classList.toggle('is-invalid', !isValid && value);
    return isValid;
}

// Update pincode validation when state changes
document.getElementById('state').addEventListener('change', function() {
    validatePincode();
});

      document.addEventListener("DOMContentLoaded", function () {
        // Check if user is logged in
        if (!Auth.isUserLoggedIn()) {
          window.location.href = "login.html";
          return;
        }

        // Add input event listeners for real-time validation
        document.getElementById("name").addEventListener("input", validateName);
        document
          .getElementById("phone")
          .addEventListener("input", validatePhone);
        document
          .getElementById("address-line1")
          .addEventListener("input", validateAddressLine1);
        document.getElementById("city").addEventListener("input", validateCity);
        document
          .getElementById("state")
          .addEventListener("change", validateState);
        document
          .getElementById("pincode")
          .addEventListener("input", validatePincode);

        const form = document.getElementById("profile-form");
        const successEl = document.getElementById("profile-success");
        const errorEl = document.getElementById("profile-error");

        // Load existing profile if available
        const profile = Auth.getUserProfile();
        if (profile) {
          document.getElementById("name").value = profile.name || "";
          document.getElementById("phone").value = profile.phone || "";

          if (profile.address) {
            document.getElementById("address-line1").value =
              profile.address.line1 || "";
            document.getElementById("address-line2").value =
              profile.address.line2 || "";
            document.getElementById("city").value = profile.address.city || "";
            document.getElementById("state").value =
              profile.address.state || "";
            document.getElementById("pincode").value =
              profile.address.pincode || "";
          }
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          e.stopPropagation();

          // Validate all fields
          const isNameValid = validateName();
          const isPhoneValid = validatePhone();
          const isAddressValid = validateAddressLine1();
          const isCityValid = validateCity();
          const isStateValid = validateState();
          const isPincodeValid = validatePincode();

          // If any validation fails, show error and return
          if (
            !isNameValid ||
            !isPhoneValid ||
            !isAddressValid ||
            !isCityValid ||
            !isStateValid ||
            !isPincodeValid
          ) {
            form.classList.add("was-validated");
            return;
          }

          // All validations passed, prepare profile data
          const userProfile = {
            name: document.getElementById("name").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            address: {
              line1: document.getElementById("address-line1").value.trim(),
              line2: document.getElementById("address-line2").value.trim(),
              city: document.getElementById("city").value.trim(),
              state: document.getElementById("state").value,
              pincode: document.getElementById("pincode").value.trim(),
            },
          };

          try {
            // Save profile
            Auth.saveUserProfile(userProfile);

            // Show success message
            successEl.textContent =
              "Profile saved successfully! Redirecting...";
            successEl.classList.remove("d-none");
            errorEl.classList.add("d-none");
            form.classList.remove("was-validated");

            // Get the redirect URL from sessionStorage or default to home
            const redirectUrl =
              sessionStorage.getItem("redirectAfterLogin") || "/";

            // If we have a redirect URL, remove it from storage
            if (sessionStorage.getItem("redirectAfterLogin")) {
              sessionStorage.removeItem("redirectAfterLogin");
            }

            // Redirect after a short delay to show success message
            setTimeout(() => {
              window.location.href = redirectUrl;
            }, 1000);
          } catch (error) {
            showError("Failed to save profile. Please try again.");
            console.error("Profile save error:", error);
          }
        });

        function showError(message) {
          errorEl.textContent = message;
          errorEl.classList.remove("d-none");
          successEl.classList.add("d-none");
        }
      });
    </script>
  </body>
</html>
